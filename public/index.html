<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web 文件管理器</title>
    <script src="assets/axios/axios.min.js"></script>
    <script src="assets/vue/vue.global.js"></script>
    <link href="assets/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="assets/font-awesome/all.min.css" rel="stylesheet">
    <link href="assets/style.css?v1" rel="stylesheet">
</head>

<body>
    <app v-cloak>
        <!-- 导航栏 -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
            <div class="container-fluid">
                <a class="navbar-brand" href="#" @click="navigateTo('/')">
                    <i class="fas fa-folder-open"></i> 文件管理器
                </a>
                <div v-if="user">
                    <span class="navbar-text me-3">欢迎, {{ user }}</span>
                    <button class="btn btn-outline-light btn-sm" @click="logout">
                        <i class="fas fa-sign-out-alt"></i> 注销
                    </button>
                </div>
            </div>
        </nav>

        <!-- 登录表单 -->
        <div v-if="!user" class="container">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-sign-in-alt"></i> 用户登录
                            </h5>
                        </div>
                        <div class="card-body">
                            <form @submit.prevent="login">
                                <div class="mb-3">
                                    <label for="username" class="form-label">用户名</label>
                                    <input type="text" class="form-control" id="username" v-model="loginForm.username"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">密码</label>
                                    <input type="password" class="form-control" id="password"
                                        v-model="loginForm.password" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100" :disabled="loading">
                                    <i class="fas fa-spinner fa-spin" v-if="loading"></i>
                                    {{ loading ? '登录中...' : '登录' }}
                                </button>
                            </form>
                            <div v-if="error" class="alert alert-danger mt-3">
                                {{ error }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主界面 -->
        <div v-if="user" class="container-fluid">
            <!-- 面包屑导航 -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="#" @click="navigateTo('/')">
                            <i class="fas fa-home"></i> 首页
                        </a>
                    </li>
                    <li v-for="(part, index) in pathParts" :key="index" class="breadcrumb-item"
                        :class="{ active: index === pathParts.length - 1 }">
                        <a v-if="index < pathParts.length - 1" href="#"
                            @click="navigateTo(pathParts.slice(0, index + 1).join('/'))">
                            {{ part }}
                        </a>
                        <span v-else>{{ part }}</span>
                    </li>
                </ol>
            </nav>

            <!-- 操作按钮 -->
            <div class="mb-3">
                <button class="btn btn-success btn-sm me-2" @click="showMkdirModal">
                    <i class="fas fa-folder"></i> 新建目录
                </button>
                <button class="btn btn-primary btn-sm me-2" @click="showNewFileModal">
                    <i class="fas fa-file"></i> 新建文件
                </button>
                <button class="btn btn-info btn-sm me-2" @click="showUploadModal">
                    <i class="fas fa-upload"></i> 上传文件
                </button>
                <button class="btn btn-secondary btn-sm" @click="refreshFiles">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>

            <!-- 文件列表 -->
            <div v-if="loading" class="loading">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p>加载中...</p>
            </div>

            <div v-else class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>名称</th>
                            <th>大小</th>
                            <th>权限</th>
                            <th>修改时间</th>
                            <th width="300">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="file in files" :key="file.name">
                            <td>
                                <i :class="getFileIcon(file)" class="file-icon"></i>
                                <a v-if="file.isDir" href="#" @click="navigateTo(file.path)">
                                    {{ file.name }}
                                </a>
                                <span v-else>{{ file.name }}</span>
                            </td>
                            <td>
                                <span v-if="!file.isDir" class="file-size">
                                    {{ formatFileSize(file.size) }}
                                </span>
                                <span v-else>-</span>
                            </td>
                            <td>{{ file.mode }}</td>
                            <td class="file-time">{{ formatTime(file.modTime) }}</td>
                            <td class="file-action">
                                <!-- 目录操作 -->
                                <template v-if="file.isDir">
                                    <button class="btn btn-outline-primary" @click="navigateTo(file.path)" title="进入目录">
                                        <i class="fas fa-folder-open"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" @click="zipDirectory(file)" title="打包目录">
                                        <i class="fas fa-file-archive"></i>
                                    </button>
                                </template>
                                <!-- 文件操作 -->
                                <template v-else>
                                    <button class="btn btn-outline-success" @click="downloadFile(file)" title="下载">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button v-if="isEditableFile(file)" class="btn btn-outline-info"
                                        @click="editFile(file)" title="编辑">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button v-if="file.name.endsWith('.zip')" class="btn btn-outline-warning"
                                        @click="unzipFile(file)" title="解压">
                                        <i class="fas fa-expand-arrows-alt"></i>
                                    </button>
                                </template>
                                <!-- 通用操作 -->
                                <button class="btn btn-outline-dark" @click="showRenameModal(file)" title="重命名">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button class="btn btn-outline-secondary" @click="showChmodModal(file)" title="权限">
                                    <i class="fas fa-key"></i>
                                </button>
                                <button class="btn btn-outline-danger" @click="deleteFile(file)" title="删除">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div v-if="files.length === 0" class="text-center text-muted py-4">
                    <i class="fas fa-folder-open fa-3x mb-3"></i>
                    <p>此目录为空</p>
                </div>
            </div>

            <!-- 错误提示 -->
            <div v-if="error" class="alert alert-danger alert-dismissible fade show">
                {{ error }}
                <button type="button" class="btn-close" @click="error = ''"></button>
            </div>

            <!-- 成功提示 -->
            <div v-if="success" class="alert alert-success alert-dismissible fade show">
                {{ success }}
                <button type="button" class="btn-close" @click="success = ''"></button>
            </div>
        </div>

        <!-- 模态框们 -->
        <!-- 新建目录模态框 -->
        <div class="modal fade" id="mkdirModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">新建目录</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="createDirectory">
                            <div class="mb-3">
                                <label for="dirName" class="form-label">目录名称</label>
                                <input type="text" class="form-control" id="dirName" v-model="mkdirForm.name" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" @click="createDirectory">创建</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 新建文件模态框 -->
        <div class="modal fade" id="newFileModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">新建文件</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="createFile">
                            <div class="mb-3">
                                <label for="fileName" class="form-label">文件名称</label>
                                <input type="text" class="form-control" id="fileName" v-model="newFileForm.name"
                                    required>
                            </div>
                            <div class="mb-3">
                                <label for="fileContent" class="form-label">文件内容</label>
                                <textarea class="form-control" id="fileContent" rows="10"
                                    v-model="newFileForm.content"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" @click="createFile">创建</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 上传文件模态框 -->
        <div class="modal fade" id="uploadModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">上传文件</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="uploadFile">
                            <div class="mb-3">
                                <label for="uploadFile" class="form-label">选择文件</label>
                                <input type="file" class="form-control" id="uploadFile" ref="fileInput" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" @click="uploadFile">上传</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 编辑文件模态框 -->
        <div class="modal fade" id="editModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">编辑文件: {{ editForm.filename }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <textarea class="form-control" rows="20" v-model="editForm.content"
                            style="font-family: 'Courier New', monospace;"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" @click="saveFile">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 重命名模态框 -->
        <div class="modal fade" id="renameModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">重命名</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="renameFile">
                            <div class="mb-3">
                                <label for="newName" class="form-label">新名称</label>
                                <input type="text" class="form-control" id="newName" v-model="renameForm.newName"
                                    required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" @click="renameFile">重命名</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 权限修改模态框 -->
        <div class="modal fade" id="chmodModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">修改权限</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form @submit.prevent="changePermissions">
                            <div class="mb-3">
                                <label for="fileMode" class="form-label">权限 (八进制)</label>
                                <input type="text" class="form-control" id="fileMode" v-model="chmodForm.mode" required
                                    placeholder="755">
                                <div class="form-text">
                                    常用权限: 755 (rwxr-xr-x), 644 (rw-r--r--), 777 (rwxrwxrwx)
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" @click="changePermissions">修改</button>
                    </div>
                </div>
            </div>
        </div>
    </app>

    <app-loading>
        <i class="fas fa-spinner fa-spin fa-3x mb-3 text-primary"></i>
        <div class="fs-5 text-secondary">加载中...</div>
    </app-loading>

    <script src="assets/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="assets/app.js?v1"></script>
</body>

</body>

</html>